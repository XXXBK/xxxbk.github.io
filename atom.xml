<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2025-07-16T03:08:54.657Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>XXXBK</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>揭秘xlsxwriter：富文本格式如何精准“染色”？&#39;</title>
    <link href="http://example.com/2025/07/16/xlsxwriter%EF%BC%9A%E5%AF%8C%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%BD%95%E7%B2%BE%E5%87%86%E2%80%9C%E6%9F%93%E8%89%B2%E2%80%9D%EF%BC%9F/"/>
    <id>http://example.com/2025/07/16/xlsxwriter%EF%BC%9A%E5%AF%8C%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%BD%95%E7%B2%BE%E5%87%86%E2%80%9C%E6%9F%93%E8%89%B2%E2%80%9D%EF%BC%9F/</id>
    <published>2025-07-16T02:48:10.000Z</published>
    <updated>2025-07-16T03:08:54.657Z</updated>
    
    <content type="html"><![CDATA[<p>核心概念</p><p>xlsxwriter 通过<strong>单元格格式</strong>和<strong>文本位置索引</strong>来精确控制文本区间样式，其判定逻辑基于以下关键内容：</p><h3 id="1-文本区间定义方式-xA"><a href="#1-文本区间定义方式-xA" class="headerlink" title="1. 文本区间定义方式&#xA;"></a>1. 文本区间定义方式&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\# 基本语法（非真实代码，仅示意逻辑）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">worksheet.write\_rich\_string(</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   row, col,&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \[format1, &quot;红色文本&quot;, format2, &quot;普通文本&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><ul><li><p><strong>位置判定</strong>：根据字符串在参数列表中的顺序确定位置</p></li><li><p><strong>格式继承</strong>：格式对象作用于紧随其后的文本段</p></li></ul><h3 id="2-关键判定规则-xA"><a href="#2-关键判定规则-xA" class="headerlink" title="2. 关键判定规则&#xA;"></a>2. 关键判定规则&#xA;</h3><table><thead><tr><th>判定维度&#xA;</th><th>说明&#xA;</th></tr></thead><tbody><tr><td>格式对象位置&#xA;</td><td>格式总是应用于下一个字符串元素&#xA;</td></tr><tr><td>文本分段&#xA;</td><td>每个字符串元素被视为独立文本段&#xA;</td></tr><tr><td>空格式处理&#xA;</td><td>None 或省略格式时继承单元格默认格式&#xA;</td></tr><tr><td>特殊字符&#xA;</td><td>换行符 (\n) 会创建新文本段但不中断格式应用&#xA;</td></tr></tbody></table><h3 id="3-实际应用示例-xA"><a href="#3-实际应用示例-xA" class="headerlink" title="3. 实际应用示例&#xA;"></a>3. 实际应用示例&#xA;</h3><h4 id="案例-1：基础红黑文本-xA"><a href="#案例-1：基础红黑文本-xA" class="headerlink" title="案例 1：基础红黑文本&#xA;"></a>案例 1：基础红黑文本&#xA;</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">red = workbook.add\_format(&#123;&#x27;color&#x27;: &#x27;red&#x27;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">black = workbook.add\_format(&#123;&#x27;color&#x27;: &#x27;black&#x27;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# &quot;答案&quot;红色，&quot;:&quot;黑色，&quot;42&quot;红色</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">worksheet.write\_rich\_string(&#x27;A1&#x27;,&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   red, &#x27;答案&#x27;,&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   black, &#x27;:&#x27;,&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   red, &#x27;42&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><p>内存中的区间映射：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\[0-2): 红色格式 (对应&quot;答案&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\[2-3): 黑色格式 (对应&quot;:&quot;)&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\[3-5): 红色格式 (对应&quot;42&quot;)</span><br></pre></td></tr></table></figure></div><h4 id="案例-2：带格式继承的文本-xA"><a href="#案例-2：带格式继承的文本-xA" class="headerlink" title="案例 2：带格式继承的文本&#xA;"></a>案例 2：带格式继承的文本&#xA;</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">bold = workbook.add\_format(&#123;&#x27;bold&#x27;: True&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">default = workbook.add\_format()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# &quot;注意&quot;加粗，后续文本默认格式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">worksheet.write\_rich\_string(&#x27;A2&#x27;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   bold, &#x27;注意&#x27;,&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   None, &#x27;：请检查数据&#x27;  # None继承单元格默认格式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><h3 id="4-特殊场景处理-xA"><a href="#4-特殊场景处理-xA" class="headerlink" title="4. 特殊场景处理&#xA;"></a>4. 特殊场景处理&#xA;</h3><h4 id="混合格式文本-xA"><a href="#混合格式文本-xA" class="headerlink" title="混合格式文本&#xA;"></a>混合格式文本&#xA;</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">\# 同一单词中部分字母标红</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">worksheet.write\_rich\_string(&#x27;A3&#x27;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   black, &#x27;Pri&#x27;,&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   red, &#x27;mar&#x27;,&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   black, &#x27;y&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><p>效果：显示为 “Primary” 其中 “mar” 为红色</p><h4 id="动态文本构建-xA"><a href="#动态文本构建-xA" class="headerlink" title="动态文本构建&#xA;"></a>动态文本构建&#xA;</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">parts = \[black, &quot;随机值：&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if highlight:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   parts.extend(\[red, str(value)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">else:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   parts.extend(\[black, str(value)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">worksheet.write\_rich\_string(&#x27;A4&#x27;, \*parts)</span><br></pre></td></tr></table></figure></div><h3 id="5-底层实现原理-xA"><a href="#5-底层实现原理-xA" class="headerlink" title="5. 底层实现原理&#xA;"></a>5. 底层实现原理&#xA;</h3><ul><li><strong>OpenXML 映射</strong>：最终生成类似以下 XML 结构</li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">\&lt;r&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; \&lt;rPr&gt;\&lt;color rgb=&quot;FFFF0000&quot;/&gt;\&lt;/rPr&gt;</span><br><span class="line"></span><br><span class="line">&amp;#x20; \&lt;t&gt;答案\&lt;/t&gt;</span><br><span class="line"></span><br><span class="line">\&lt;/r&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\&lt;r&gt;</span><br><span class="line"></span><br><span class="line">&amp;#x20; \&lt;rPr&gt;\&lt;color rgb=&quot;FF000000&quot;/&gt;\&lt;/rPr&gt;</span><br><span class="line"></span><br><span class="line">&amp;#x20; \&lt;t&gt;:\&lt;/t&gt;</span><br><span class="line"></span><br><span class="line">\&lt;/r&gt;</span><br></pre></td></tr></table></figure></div><ul><li><strong>索引计算</strong>：库内部维护格式栈，根据参数顺序计算每个文本段的起止位置</li></ul><h3 id="6-使用限制与注意事项-xA"><a href="#6-使用限制与注意事项-xA" class="headerlink" title="6. 使用限制与注意事项&#xA;"></a>6. 使用限制与注意事项&#xA;</h3><ul><li><p><strong>不可变特性</strong>：一旦写入无法修改单个文本段格式</p></li><li><p><strong>性能影响</strong>：每个格式变化都会创建新的<code>&lt;r&gt;</code>元素，过多分段影响文件大小</p></li><li><p><strong>边界情况</strong>：</p><ul><li><p>空字符串仍会占用格式区间</p></li><li><p>连续的相同格式不会自动合并</p></li></ul></li></ul><h3 id="7-调试技巧-xA"><a href="#7-调试技巧-xA" class="headerlink" title="7. 调试技巧&#xA;"></a>7. 调试技巧&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">\# 查看实际生成的XML（需要保存文件后解压查看）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">workbook.filename = &#x27;output.xlsx&#x27;</span><br><span class="line"></span><br><span class="line">workbook.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 解压后查看xl/worksheets/sheet1.xml</span><br></pre></td></tr></table></figure></div><h3 id="最佳实践建议-xA"><a href="#最佳实践建议-xA" class="headerlink" title="最佳实践建议&#xA;"></a>最佳实践建议&#xA;</h3><ul><li><p>批量合并相同格式的文本段</p></li><li><p>对静态内容预先生成格式列表</p></li><li><p>避免单个单元格内超过 20 个格式分段</p></li><li><p>对动态内容使用辅助函数构建参数列表</p></li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def build\_rich\_text(text\_parts):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   result = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for text, fmt in text\_parts:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       result.extend(\[fmt, text])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   return result</span><br></pre></td></tr></table></figure></div><p><strong>注</strong>：与 openpyxl 的 CellRichText 不同，xlsxwriter 采用更底层的格式绑定机制，对文本区间的判定完全基于参数序列顺序，不依赖任何文本标记符号。</p><h3 id="关键要点总结-xA"><a href="#关键要点总结-xA" class="headerlink" title="关键要点总结&#xA;"></a>关键要点总结&#xA;</h3><ol><li><p>xlsxwriter 的文本区间判定是<strong>顺序敏感</strong>的</p></li><li><p>格式对象总是<strong>向前绑定</strong>到下一个文本元素</p></li><li><p>实际渲染时会将文本区间映射为 OpenXML 的<code>&lt;r&gt;</code>元素</p></li><li><p>处理富文本时需要特别注意参数列表的构建顺序</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;核心概念&lt;/p&gt;
&lt;p&gt;xlsxwriter 通过&lt;strong&gt;单元格格式&lt;/strong&gt;和&lt;strong&gt;文本位置索引&lt;/strong&gt;来精确控制文本区间样式，其判定逻辑基于以下关键内容：&lt;/p&gt;
&lt;h3 id=&quot;1-文本区间定义方式-xA&quot;&gt;&lt;a href=&quot;#1-</summary>
      
    
    
    
    <category term="Python库应用" scheme="http://example.com/categories/Python%E5%BA%93%E5%BA%94%E7%94%A8/"/>
    
    
    <category term="Excel" scheme="http://example.com/tags/Excel/"/>
    
    <category term="Python" scheme="http://example.com/tags/Python/"/>
    
    <category term="xlsxwriter" scheme="http://example.com/tags/xlsxwriter/"/>
    
    <category term="格式化" scheme="http://example.com/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>docker离线部署：穿越网络屏障的容器编排利器</title>
    <link href="http://example.com/2025/07/16/docker%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2%EF%BC%9A%E7%A9%BF%E8%B6%8A%E7%BD%91%E7%BB%9C%E5%B1%8F%E9%9A%9C%E7%9A%84%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%88%A9%E5%99%A8/"/>
    <id>http://example.com/2025/07/16/docker%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2%EF%BC%9A%E7%A9%BF%E8%B6%8A%E7%BD%91%E7%BB%9C%E5%B1%8F%E9%9A%9C%E7%9A%84%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%88%A9%E5%99%A8/</id>
    <published>2025-07-16T01:52:06.000Z</published>
    <updated>2025-07-16T03:01:36.967Z</updated>
    
    <content type="html"><![CDATA[<p>一、Docker Compose 离线安装步骤</p><p>在 GitHub 上找到对应的 docker-compose 网站，下载适合当前系统的离线安装包（如 docker-compose-linux-x86_64），并将其放置在 &#x2F;tmp 目录下。</p><h3 id="赋予执行权限并移动至系统路径-xA"><a href="#赋予执行权限并移动至系统路径-xA" class="headerlink" title="赋予执行权限并移动至系统路径&#xA;"></a>赋予执行权限并移动至系统路径&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">\# 赋予可执行权限</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chmod +x /tmp/docker-compose-linux-x86\_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 移动到系统可执行目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo mv /tmp/docker-compose-linux-x86\_64 /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure></div><h3 id="验证安装结果-xA"><a href="#验证安装结果-xA" class="headerlink" title="验证安装结果&#xA;"></a>验证安装结果&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 输出示例：docker-compose version 2.20.3, build a8266d3</span><br></pre></td></tr></table></figure></div><p>二、常见问题与解决方法</p><h3 id="权限不足问题-xA"><a href="#权限不足问题-xA" class="headerlink" title="权限不足问题&#xA;"></a>权限不足问题&#xA;</h3><h4 id="问题-xA"><a href="#问题-xA" class="headerlink" title="问题&#xA;"></a>问题&#xA;</h4><p>执行 mv 时提示权限错误。</p><h4 id="解决-xA"><a href="#解决-xA" class="headerlink" title="解决&#xA;"></a>解决&#xA;</h4><p>使用 sudo 命令获取管理员权限：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv /tmp/docker-compose-linux-x86\_64 /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure></div><h3 id="命令不存在问题-xA"><a href="#命令不存在问题-xA" class="headerlink" title="命令不存在问题&#xA;"></a>命令不存在问题&#xA;</h3><h4 id="问题-xA-1"><a href="#问题-xA-1" class="headerlink" title="问题&#xA;"></a>问题&#xA;</h4><p>输入 docker-compose 提示命令未找到。</p><h4 id="解决-xA-1"><a href="#解决-xA-1" class="headerlink" title="解决&#xA;"></a>解决&#xA;</h4><p>检查系统路径是否包含 &#x2F;usr&#x2F;local&#x2F;bin：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo \$PATH  # 若不含 /usr/local/bin，添加至环境变量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export PATH=\$PATH:/usr/local/bin</span><br></pre></td></tr></table></figure></div><h3 id="文件名空格问题-xA"><a href="#文件名空格问题-xA" class="headerlink" title="文件名空格问题&#xA;"></a>文件名空格问题&#xA;</h3><h4 id="问题-xA-2"><a href="#问题-xA-2" class="headerlink" title="问题&#xA;"></a>问题&#xA;</h4><p>脚本文件名含前导空格导致命令失败。</p><h4 id="解决-xA-2"><a href="#解决-xA-2" class="headerlink" title="解决&#xA;"></a>解决&#xA;</h4><p>重命名文件去除空格：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv &#x27; replace\_image\_registry.sh&#x27; replace\_image\_registry.sh</span><br></pre></td></tr></table></figure></div><p>三、核心命令总结</p><h3 id="安装核心步骤-xA"><a href="#安装核心步骤-xA" class="headerlink" title="安装核心步骤&#xA;"></a>安装核心步骤&#xA;</h3><p>下载 → 赋权 → 移动 → 验证</p><h3 id="关键命令-xA"><a href="#关键命令-xA" class="headerlink" title="关键命令&#xA;"></a>关键命令&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /tmp/docker-compose-linux-x86\_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo mv /tmp/docker-compose-linux-x86\_64 /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;一、Docker Compose 离线安装步骤&lt;/p&gt;
&lt;p&gt;在 GitHub 上找到对应的 docker-compose 网站，下载适合当前系统的离线安装包（如 docker-compose-linux-x86_64），并将其放置在 &amp;#x2F;tmp 目录下。&lt;/p&gt;
</summary>
      
    
    
    
    <category term="容器技术" scheme="http://example.com/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/"/>
    
    <category term="部署实践" scheme="http://example.com/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/"/>
    
    
    <category term="Docker Compose" scheme="http://example.com/tags/Docker-Compose/"/>
    
    <category term="离线安装" scheme="http://example.com/tags/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85/"/>
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Portainer容器管理实战：从镜像加速到安全部署</title>
    <link href="http://example.com/2025/07/15/Portainer%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%88%B0%E5%AE%89%E5%85%A8%E9%83%A8%E7%BD%B2/"/>
    <id>http://example.com/2025/07/15/Portainer%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%88%B0%E5%AE%89%E5%85%A8%E9%83%A8%E7%BD%B2/</id>
    <published>2025-07-15T09:50:31.000Z</published>
    <updated>2025-07-15T09:56:57.921Z</updated>
    
    <content type="html"><![CDATA[<p>一、背景：为什么选择从第三方镜像源拉取 Portainer？</p><p>近期在学习容器管理工具 Portainer 时，参考了一篇技术教程（知乎链接：<a class="link"   href="https://zhuanlan.zhihu.com/p/27740131259" >https://zhuanlan.zhi<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><a class="link"   href="https://zhuanlan.zhihu.com/p/27740131259" >hu<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><a class="link"   href="https://zhuanlan.zhihu.com/p/27740131259" >.com&#x2F;<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><a class="link"   href="https://zhuanlan.zhihu.com/p/27740131259" >p&#x2F;2<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><a class="link"   href="https://zhuanlan.zhihu.com/p/27740131259" >7740<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><a class="link"   href="https://zhuanlan.zhihu.com/p/27740131259" >1312<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><a class="link"   href="https://zhuanlan.zhihu.com/p/27740131259" >59<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>），教程中推荐使用官方镜像源部署。但由于网络环境限制，尝试从第三方镜像源<code>docker.1ms.run</code>拉取 Portainer 镜像，意外发现该镜像源提供了更稳定的下载速度，因此记录下完整操作流程，供遇到类似问题的开发者参考。</p><p>二、操作步骤：从镜像拉取到容器启动的全流程</p><h3 id="1-拉取-Portainer-镜像-xA"><a href="#1-拉取-Portainer-镜像-xA" class="headerlink" title="1. 拉取 Portainer 镜像&#xA;"></a>1. 拉取 Portainer 镜像&#xA;</h3><p>通常情况下，Portainer 官方镜像的拉取命令为：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer-ce:latest</span><br></pre></td></tr></table></figure></div><p>但本次尝试使用第三方镜像源：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.1ms.run/portainer/portainer-ce:latest</span><br></pre></td></tr></table></figure></div><p>执行结果：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Using default tag: latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">latest: Pulling from portainer/portainer-ce</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">63c930229559: Pull complete&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d3b1c06ebf8c: Pull complete&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...（中间层拉取省略）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Digest: sha256:224a378fbc5ae579dc9d570c5ca2e5e981a4a003c8d7c2c5b5e482af97c2f87c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Status: Downloaded newer image for docker.1ms.run/portainer/portainer-ce:latest</span><br></pre></td></tr></table></figure></div><p><strong>注意事项：</strong></p><ul><li><p>第三方镜像源可能存在安全风险，建议优先使用官方镜像（<code>portainer/portainer-ce</code>）。</p></li><li><p>若拉取失败，可检查镜像源是否可用（如执行<code>ping docker.1ms.run</code>），或切换至国内加速源（如 Docker 中国镜像站）。</p></li></ul><h3 id="2-验证镜像是否成功拉取-xA"><a href="#2-验证镜像是否成功拉取-xA" class="headerlink" title="2. 验证镜像是否成功拉取&#xA;"></a>2. 验证镜像是否成功拉取&#xA;</h3><p>通过<code>docker images</code>命令查看本地镜像列表：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure></div><p>输出结果：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                              TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line"></span><br><span class="line">docker.1ms.run/portainer/portainer-ce   latest    71de3839351a   2 days ago    268MB</span><br></pre></td></tr></table></figure></div><h3 id="3-启动-Portainer-容器-xA"><a href="#3-启动-Portainer-容器-xA" class="headerlink" title="3. 启动 Portainer 容器&#xA;"></a>3. 启动 Portainer 容器&#xA;</h3><p>使用以下命令启动容器，并配置挂载与端口映射：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; \--name portainer \\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; -p 9000:9000 \\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; -v /var/run/docker.sock:/var/run/docker.sock \\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; -v portainer\_data:/data \\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; \--restart=always \\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; docker.1ms.run/portainer/portainer-ce:latest</span><br></pre></td></tr></table></figure></div><p><strong>参数解析：</strong></p><ul><li><p><code>-d</code>：后台运行容器；</p></li><li><p><code>-p 9000:9000</code>：映射宿主机 9000 端口到容器 9000 端口，用于访问 Web 界面；</p></li><li><p><code>-v /var/run/docker.sock:/var/run/docker.sock</code>：挂载 Docker 套接字，允许 Portainer 管理宿主机 Docker 环境；</p></li><li><p><code>-v portainer_data:/data</code>：创建数据卷持久化存储 Portainer 配置；</p></li><li><p><code>--restart=always</code>：确保容器随系统重启自动运行。</p></li></ul><h3 id="4-访问-Portainer-Web-界面-xA"><a href="#4-访问-Portainer-Web-界面-xA" class="headerlink" title="4. 访问 Portainer Web 界面&#xA;"></a>4. 访问 Portainer Web 界面&#xA;</h3><p>容器启动后，在浏览器中输入<code>http://宿主机IP:9000</code>，首次访问需设置管理员密码，随后进入 Portainer 管理界面。</p><p>三、遇到的问题与解决方案</p><h3 id="1-镜像拉取失败：manifest-unknown-xA"><a href="#1-镜像拉取失败：manifest-unknown-xA" class="headerlink" title="1. 镜像拉取失败：manifest unknown&#xA;"></a>1. 镜像拉取失败：manifest unknown&#xA;</h3><p><strong>错误信息：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error response from daemon: manifest for docker.1ms.run/portainer-ce:latest not found: manifest unknown</span><br></pre></td></tr></table></figure></div><p><strong>原因：</strong></p><p>镜像源中无该镜像，或镜像名称拼写错误（如<code>portainer-ce</code>写成<code>portainer</code>）。</p><p><strong>解决方法：</strong></p><p>确认镜像名称正确性，或更换为官方镜像源拉取：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer-ce:latest</span><br></pre></td></tr></table></figure></div><h3 id="2-Docker-Hub-连接超时-xA"><a href="#2-Docker-Hub-连接超时-xA" class="headerlink" title="2. Docker Hub 连接超时&#xA;"></a>2. Docker Hub 连接超时&#xA;</h3><p><strong>错误信息：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error response from daemon: Get &quot;https://registry-1.docker.io/v2/&quot;: context deadline exceeded</span><br></pre></td></tr></table></figure></div><p><strong>解决方法：</strong></p><p>配置国内镜像加速源，编辑<code>/etc/docker/daemon.json</code>添加：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; &quot;registry-mirrors&quot;: \[&quot;https://registry.docker-cn.com&quot;, &quot;https://docker.mirrors.ustc.edu.cn&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>重启 Docker 服务：<code>sudo systemctl restart docker</code>。</p><p>四、使用第三方镜像源的风险与建议</p><ul><li><p><strong>安全风险</strong>：第三方镜像源可能被篡改，建议优先使用官方镜像（<code>portainer/portainer-ce</code>）。</p></li><li><p><strong>版本兼容性</strong>：第三方镜像可能非最新版本，建议定期通过<code>docker pull</code>更新镜像。</p></li><li><p><strong>网络稳定性</strong>：若第三方源频繁失效，优先使用官方源或国内大厂加速源（如阿里云、腾讯云镜像站）。</p></li></ul><p>五、总结：Portainer 的价值与容器管理实践</p><p>通过 Docker 部署 Portainer 后，可直观管理容器、镜像、网络及数据卷，尤其适合新手快速上手容器化部署。本次从第三方镜像源拉取的经历表明：技术实践中需在效率与安全性间权衡，建议在测试环境尝试非官方源，生产环境务必使用官方可信镜像。</p><p>后续可进一步探索 Portainer 的 Kubernetes 管理、RBAC 权限控制等高级功能，提升容器化应用的部署与运维效率。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;一、背景：为什么选择从第三方镜像源拉取 Portainer？&lt;/p&gt;
&lt;p&gt;近期在学习容器管理工具 Portainer 时，参考了一篇技术教程（知乎链接：&lt;a class=&quot;link&quot;   href=&quot;https://zhuanlan.zhihu.com/p/2774013</summary>
      
    
    
    
    <category term="Docker实践" scheme="http://example.com/categories/Docker%E5%AE%9E%E8%B7%B5/"/>
    
    
    <category term="Docker" scheme="http://example.com/tags/Docker/"/>
    
    <category term="Portainer" scheme="http://example.com/tags/Portainer/"/>
    
    <category term="镜像加速" scheme="http://example.com/tags/%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/"/>
    
    <category term="容器管理" scheme="http://example.com/tags/%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Python 魔法：一键让 Excel 正确选项「脸红」</title>
    <link href="http://example.com/2025/07/15/Python-%E9%AD%94%E6%B3%95%EF%BC%9A%E4%B8%80%E9%94%AE%E8%AE%A9-Excel-%E6%AD%A3%E7%A1%AE%E9%80%89%E9%A1%B9%E3%80%8C%E8%84%B8%E7%BA%A2%E3%80%8D/"/>
    <id>http://example.com/2025/07/15/Python-%E9%AD%94%E6%B3%95%EF%BC%9A%E4%B8%80%E9%94%AE%E8%AE%A9-Excel-%E6%AD%A3%E7%A1%AE%E9%80%89%E9%A1%B9%E3%80%8C%E8%84%B8%E7%BA%A2%E3%80%8D/</id>
    <published>2025-07-15T09:21:07.000Z</published>
    <updated>2025-07-16T01:50:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>在数据处理工作中，我们经常需要处理 Excel 文件中的试题数据，特别是需要对正确答案进行特殊标记。本文将分享我从最初实现到最终优化的完整改进过程。</p><p>初始需求</p><p>我们需要处理一个包含试题的 Excel 文件，具体要求：</p><ul><li><p>文件包含 “试题选项” 和 “试题答案” 两列</p></li><li><p>试题选项用 “$$;$“ 分隔多个选项</p></li><li><p>需要根据 “试题答案” 将正确答案标记为红色</p></li><li><p>处理后的结果直接修改原文件</p></li></ul><p>第一版实现</p><h3 id="核心思路：-xA"><a href="#核心思路：-xA" class="headerlink" title="核心思路：&#xA;"></a>核心思路：&#xA;</h3><ul><li><p>使用 pandas 读取 Excel 文件</p></li><li><p>用 openpyxl 修改原文件样式</p></li><li><p>在正确答案前后添加 “**“ 标记</p></li><li><p>提示用户手动替换 “**“ 为红色格式</p></li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">\# 主要处理逻辑</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">marked\_options = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i, option in enumerate(options):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if i in correct\_indices:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       marked\_options.append(f&quot;\*\*&#123;option&#125;\*\*&quot;)  # 用\*\*标记正确答案</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   else:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       marked\_options.append(option)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cell.value = &#x27;\$;\$&#x27;.join(marked\_options)</span><br></pre></td></tr></table></figure></div><p><strong>问题：</strong></p><p>不能自动设置红色，需要用户手动替换，** 的标记方式不够直观</p><p>第二版改进</p><h3 id="改进点：-xA"><a href="#改进点：-xA" class="headerlink" title="改进点：&#xA;"></a>改进点：&#xA;</h3><ul><li><p>改用 xlsxwriter 引擎</p></li><li><p>直接处理 ** 标记的内容并设置为红色</p></li><li><p>保留 ** 标记</p></li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">\# 使用正则匹配\*\*内容并设置格式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for match in re.finditer(r&#x27;\\\\\\\*\\\\\\\*(.\*?)\\\\\\\*\\\\\\\*&#x27;, cell\_value):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   parts.append(&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#x27;text&#x27;: f&quot;\*\*&#123;match.group(1)&#125;\*\*&quot;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#x27;format&#x27;: red\_format</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &#125;)</span><br></pre></td></tr></table></figure></div><p><strong>问题：</strong></p><p>使用 ** 将正确答案括起来的话，xlsxwriter 无法非常准确地解析出来，因为答案可能是 <strong>A</strong>$;$B$;$C$;$<strong>D</strong> 这样子的，相同的符号会干扰它的判断，从而导致效果不好</p><p>最终版改进</p><h3 id="改进思路：-xA"><a href="#改进思路：-xA" class="headerlink" title="改进思路：&#xA;"></a>改进思路：&#xA;</h3><ul><li><p>改回使用 openpyxl</p></li><li><p>正确答案用 [] 标记</p></li><li><p>非正确答案不做标记</p></li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">marked\_options = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i, option in enumerate(options):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if i in correct\_indices:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       marked\_options.append(f&quot;\[&#123;option&#125;]&quot;) # 正确答案标记</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   else:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       marked\_options.append(option)</span><br></pre></td></tr></table></figure></div><p>然后再进行标红处理：</p><ul><li><p>使用富文本 (CellRichText) 直接设置红色</p></li><li><p>自动移除 [] 标记</p></li><li><p>添加异常处理，失败时回退到普通文本</p></li><li><p>更友好的提示信息</p></li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">\# 富文本处理核心代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rich\_text = CellRichText()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i, option in enumerate(options):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if i &gt; 0:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       rich\_text.append(&#x27;\$;\$&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   clean\_option = option.replace(&#x27;\[&#x27;, &#x27;&#x27;).replace(&#x27;]&#x27;, &#x27;&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if i in correct\_indices:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       rich\_text.append(TextBlock(inline\_red\_font, clean\_option))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   else:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       rich\_text.append(clean\_option)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cell.value = rich\_text</span><br></pre></td></tr></table></figure></div><h3 id="关键改进点：-xA"><a href="#关键改进点：-xA" class="headerlink" title="关键改进点：&#xA;"></a>关键改进点：&#xA;</h3><ul><li><p><strong>富文本支持</strong>：使用 CellRichText 和 TextBlock 实现对单个字符的样式设置</p></li><li><p><strong>自动清理</strong>：移除选项中的 [] 标记</p></li></ul><p>拓展功能：标记检查与统一分隔符</p><p>在最终版的基础上，我进一步完善了代码，增加了两项重要的功能：统一处理非标准分隔符和全面的标记检查报告。这使得整个流程更加健壮和智能化。</p><h3 id="1-统一分隔符-xA"><a href="#1-统一分隔符-xA" class="headerlink" title="1. 统一分隔符&#xA;"></a>1. 统一分隔符&#xA;</h3><p>很多时候，Excel 中的选项分隔符可能不统一，除了标准的$;$，还可能出现$;、$$等，甚至单空格加 $ 等多种形式。为了确保选项能够被正确解析，我加入了强大的正则表达式来识别并统一这些非标准分隔符为 $;$。</p><p>实现方式：使用 re.compile 定义了一个详细的正则表达式 separator_pattern，涵盖了多种常见的非标准分隔符。</p><p>效果：在处理每个选项字符串时，首先使用 separator_pattern.sub (‘$;$’, options_str) 将所有识别到的非标准分隔符统一替换为 $;$ 。这大大提高了数据处理的鲁棒性，减少了因格式不一致导致的问题。</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">\# 正则表达式定义（部分）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">separator\_pattern = re.compile(r&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \$;\$|       # 标准 \$;\$ \[cite: 3]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \$:：\$|   # \$:\$ 或 \$：\$ \[cite: 4]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   ;\$|         # ;\$ \[cite: 5]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \$；|        # \$； \[cite: 6]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \[；:：]\$|   # ；\$ 或 ：\$ \[cite: 7]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   $\[;；:：]|  # \$; 或 \$；或 \$: 或 \$： \[cite: 8]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \$\$|        # \$\$ \[cite: 9]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \s&#123;2,&#125;|      # 两个或更多空格 \[cite: 10]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \$\s|\s\$|   # \$ 后或前有单个空格 \[cite: 11]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   ;           # 单独的分号 \[cite: 12]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;, re.VERBOSE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 在处理选项字符串时进行替换</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">modified\_str = separator\_pattern.sub(&#x27;\$;\$&#x27;, options\_str)</span><br></pre></td></tr></table></figure></div><h3 id="2-标记检查报告-xA"><a href="#2-标记检查报告-xA" class="headerlink" title="2. 标记检查报告&#xA;"></a>2. 标记检查报告&#xA;</h3><p>仅仅对正确答案进行标记是不够的，我们还需要验证标记是否正确、是否有遗漏。此功能可以生成详细的报告，指出 “正确答案未被标记” 和 “错误答案被标记” 的情况。</p><h4 id="核心逻辑优化：-xA"><a href="#核心逻辑优化：-xA" class="headerlink" title="核心逻辑优化：&#xA;"></a>核心逻辑优化：&#xA;</h4><ul><li><p><strong>未标记检查</strong>：传统的检查方法是看 “标记索引” 中是否包含正确答案的索引。但如果正确答案完全没有被标记（即选项中根本没有 []），这种方法就无法识别。新的逻辑直接检查正确答案的选项内容是否被 [] 包裹 。只要正确答案未被 [] 包裹，无论是否有其他标记动作，都会被识别为 “未标记” 。</p></li><li><p><strong>错误标记检查</strong>：检查所有被 [] 包裹的选项，如果其索引不在正确答案的索引列表中，则视为错误标记 。</p></li></ul><h4 id="输出报告：-xA"><a href="#输出报告：-xA" class="headerlink" title="输出报告：&#xA;"></a>输出报告：&#xA;</h4><p>生成清晰的报告，包含：</p><ul><li><p>检查的总行数 。</p></li><li><p>“未标记正确答案的行” 数量及具体详情（Excel 行号、应标记的字母、未被包裹的实际内容） 。</p></li><li><p>“错误标记的行” 数量及具体详情（Excel 行号、错误标记的内容、正确的答案） 。</p></li></ul><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">\# 未标记行检查的核心代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">has\_unmarked = False</span><br><span class="line"></span><br><span class="line">for i in correct\_indices:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   opt = options\[i]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 直接检查正确答案是否被\[]包裹&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if not (opt.strip().startswith(&#x27;\[&#x27;) and opt.strip().endswith(&#x27;]&#x27;)):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       has\_unmarked = True</span><br><span class="line"></span><br><span class="line">&amp;#x20;       break</span><br><span class="line"></span><br><span class="line">if has\_unmarked: # \[cite: 16]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   unmarked\_rows.append(&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#x27;row&#x27;: row\_num,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#x27;expected&#x27;: \[chr(65 + i) for i in correct\_indices],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#x27;actual&#x27;: \[options\[i].strip() for i in correct\_indices]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 错误标记行检查的核心代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">marked\_indices = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i, opt in enumerate(options):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if opt.strip().startswith(&#x27;\[&#x27;) and opt.strip().endswith(&#x27;]&#x27;):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       marked\_indices.append(i)  # 记录被标记的索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in marked\_indices: #&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if i not in correct\_indices:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       wrong\_marking.append(&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;row&#x27;: row\_num,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;wrong\_marked&#x27;: options\[i].strip(),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;correct&#x27;: \[chr(65 + i) for i in correct\_indices] #&amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       break # 只要有一个错误标记就记录</span><br></pre></td></tr></table></figure></div><h4 id="验证示例：-xA"><a href="#验证示例：-xA" class="headerlink" title="验证示例：&#xA;"></a>验证示例：&#xA;</h4><p>如果一个 Excel 行的正确答案是 D，但选项 D 没有被 [] 包裹，运行代码后会输出：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\=== 标记检查报告 ===</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">共检查 1000 行数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1\. 未标记正确答案的行: 1 行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20; 行X: 应标记\[&#x27;D&#x27;]（内容：D、财务收支审批人员的奖惩办法）未被\[]包裹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2\. 错误标记的行: 0 行</span><br></pre></td></tr></table></figure></div><p>这使得我们能够精准识别 “应该标记但完全没标记” 的情况 。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在数据处理工作中，我们经常需要处理 Excel 文件中的试题数据，特别是需要对正确答案进行特殊标记。本文将分享我从最初实现到最终优化的完整改进过程。&lt;/p&gt;
&lt;p&gt;初始需求&lt;/p&gt;
&lt;p&gt;我们需要处理一个包含试题的 Excel 文件，具体要求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;</summary>
      
    
    
    
    <category term="Excel" scheme="http://example.com/categories/Excel/"/>
    
    <category term="Python" scheme="http://example.com/categories/Excel/Python/"/>
    
    <category term="数据处理" scheme="http://example.com/categories/Excel/Python/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/"/>
    
    
    <category term="Excel" scheme="http://example.com/tags/Excel/"/>
    
    <category term="Pandas" scheme="http://example.com/tags/Pandas/"/>
    
    <category term="Python" scheme="http://example.com/tags/Python/"/>
    
    <category term="Openpyxl" scheme="http://example.com/tags/Openpyxl/"/>
    
    <category term="Xlsxwriter" scheme="http://example.com/tags/Xlsxwriter/"/>
    
    <category term="正则表达式" scheme="http://example.com/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Python 魔法：一键让 Excel 正确选项「脸红」</title>
    <link href="http://example.com/2025/07/15/Python%E9%AD%94%E6%B3%95%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB%E8%AE%A9PDF%E6%B0%B4%E5%8D%B0%E9%9A%90%E5%BD%A2%EF%BC%9F/"/>
    <id>http://example.com/2025/07/15/Python%E9%AD%94%E6%B3%95%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB%E8%AE%A9PDF%E6%B0%B4%E5%8D%B0%E9%9A%90%E5%BD%A2%EF%BC%9F/</id>
    <published>2025-07-15T09:21:07.000Z</published>
    <updated>2025-07-16T01:50:49.691Z</updated>
    
    <content type="html"><![CDATA[<p>在日常工作中，我们经常会遇到带有特定特征的 PDF 水印，比如固定的字体大小、倾斜角度、透明度和颜色。这些特性为我们提供了更精准地识别水印的依据。今天，我们就来深入探讨如何利用 PyMuPDF (Fitz) 库，基于这些特征实现 PDF 水印的精确识别和去除，并整合多种实用方法，帮你应对不同场景。</p><p>特定特征水印的识别原理</p><p>PDF 文件中的文本和图形对象都包含了丰富的元数据信息，例如字体大小、旋转角度、透明度和颜色。当水印具有固定特征时，我们可以通过以下步骤实现精准识别：</p><ol><li><p><strong>解析 PDF 页面内容</strong>： 获取页面上所有的文本和图形对象。</p></li><li><p><strong>提取对象特征</strong>： 获取每个对象的字体大小、旋转角度、透明度和颜色等信息。</p></li><li><p><strong>特征匹配</strong>： 将提取到的特征与我们已知的水印特征进行比对。</p></li><li><p><strong>处理匹配对象</strong>： 对符合水印特征的对象进行删除或覆盖处理。</p></li></ol><p>典型的 PDF 水印通常具备以下特征：</p><ul><li><p>📐 固定倾斜角度 (常见 15-45 度)</p></li><li><p>🎨 固定颜色 (常见浅灰色 #C0C0C0)</p></li><li><p>🌫 固定透明度 (约 30-50%)</p></li><li><p>🔠 固定字体大小 (通常较大)</p></li><li><p>🔄 重复出现在每一页相同位置</p></li></ul><p>使用 PyMuPDF 实现基于特征的水印处理</p><h3 id="方法一：基于字体大小和旋转角度的水印识别-xA"><a href="#方法一：基于字体大小和旋转角度的水印识别-xA" class="headerlink" title="方法一：基于字体大小和旋转角度的水印识别&#xA;"></a>方法一：基于字体大小和旋转角度的水印识别&#xA;</h3><p>这个方法非常适合那些字体大小和倾斜角度都比较固定的水印。</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">import fitz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def remove\_watermark\_by\_font\_size\_and\_rotation(input\_pdf, output\_pdf, font\_size, rotation\_angle):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   根据字体大小和旋转角度去除PDF中的水印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   input\_pdf (str): 输入PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   output\_pdf (str): 输出PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   font\_size (float): 水印字体大小</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   rotation\_angle (float): 水印旋转角度 (度)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc = fitz.open(input\_pdf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for page in doc:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 获取页面上的所有文本和它们的属性</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       text\_infos = page.get\_text(&quot;dict&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       for block in text\_infos\[&quot;blocks&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           if &quot;lines&quot; in block:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               for line in block\[&quot;lines&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   for span in line\[&quot;spans&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 提取字体大小和旋转角度</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       current\_size = span\[&quot;size&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 计算旋转角度 (PyMuPDF中通过变换矩阵计算)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       matrix = fitz.Matrix(span\[&quot;matrix&quot;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# matrix.decompose() 返回 (a, b, c, d, e, f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 旋转角度通过 atan2(b, a) 或 atan2(-c, d) 计算。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 对于简单的旋转，alpha 和 beta 应该近似相等或互补。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 这里我们简化，直接使用 atan2(matrix.b, matrix.a) 转换成角度</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       import math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       current\_rotation = math.degrees(math.atan2(matrix.b, matrix.a))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 检查是否匹配水印特征，并允许一定的误差</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       if (abs(current\_size - font\_size) &lt; 1.5 and # 允许轻微误差</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           abs(current\_rotation - rotation\_angle) &lt; 5.0): # 允许5度误差</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           \# 创建一个矩形区域用于覆盖水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           page.add\_redact\_annot(fitz.Rect(span\[&quot;bbox&quot;]), text=&quot;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 应用所有编辑</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       page.apply\_redactions()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 保存修改后的PDF</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.save(output\_pdf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.close()</span><br></pre></td></tr></table></figure></div><p><strong>代码解析</strong>：</p><ul><li><p>我们使用 <code>page.get_text(&quot;dict&quot;)</code> 获取页面上所有的文本信息，包括它们的各种属性。</p></li><li><p>从文本跨度 (span) 中提取 字体大小 和 变换矩阵。</p></li><li><p>通过分解变换矩阵来计算文本的 旋转角度。这里使用了 <code>math.atan2(matrix.b, matrix.a)</code> 来更准确地获取旋转角度。</p></li><li><p>将提取到的特征与你已知的水印特征进行比较，如果匹配（并允许一定的误差范围），就用一个空白矩形覆盖水印区域。</p></li></ul><p><strong>难易度</strong>：★★★☆☆</p><p><strong>优点</strong>： 对具有固定字体大小和倾斜角度的水印效果特别好，误判率低。</p><p><strong>缺点</strong>： 需要你预先知道水印的字体大小和旋转角度参数。</p><h3 id="方法二：基于透明度和颜色的水印识别-xA"><a href="#方法二：基于透明度和颜色的水印识别-xA" class="headerlink" title="方法二：基于透明度和颜色的水印识别&#xA;"></a>方法二：基于透明度和颜色的水印识别&#xA;</h3><p>这种方法适用于那些有固定透明度和颜色的水印，特别是半透明的浅色水印。</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">import fitz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def remove\_watermark\_by\_opacity\_and\_color(input\_pdf, output\_pdf, opacity\_threshold, color\_rgb\_target, color\_tolerance=10):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   根据透明度和颜色去除PDF中的水印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   input\_pdf (str): 输入PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   output\_pdf (str): 输出PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   opacity\_threshold (float): 水印透明度阈值 (0.0-1.0)，低于此值可能认为是水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_rgb\_target (tuple): 水印颜色的RGB值，如 (200, 200, 200)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_tolerance (int): 颜色匹配的容差范围 (0-255)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc = fitz.open(input\_pdf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for page in doc:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 获取页面上所有的绘图指令</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# PyMuPDF 直接从get\_text(&quot;dict&quot;)获取的span里没有透明度信息，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 透明度通常是在图形状态(graphics state)中设置的，需要解析PDF内容流才能获取。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 这里为了演示，我们假设透明度信息可以通过更复杂的解析获得，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 或者通过图像渲染后分析像素来实现。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 简化处理：对于文本水印，通常颜色和位置是更可靠的特征。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 如果需要精确的透明度识别，需要更深入的PDF内容流解析。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 遍历页面上的所有文本</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       text\_infos = page.get\_text(&quot;dict&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       for block in text\_infos\[&quot;blocks&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           if &quot;lines&quot; in block:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               for line in block\[&quot;lines&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   for span in line\[&quot;spans&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 提取颜色信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       color\_int = span\[&quot;color&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       r = (color\_int &gt;&gt; 16) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                       g = (color\_int &gt;&gt; 8) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                       b = color\_int &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                       current\_color\_rgb = (r, g, b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 在PyMuPDF的文本span信息中直接获取透明度是比较复杂的，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 因为透明度是图形状态的一部分，而不是文本本身的一个属性。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 对于真正的透明度匹配，通常需要渲染页面并分析像素的alpha通道，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 或者解析更底层的PDF内容流。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 为了演示，我们在这里简化，假设所有文本都是不透明的，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 除非通过其他方式确认其透明度。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 如果 watermark 是图像，则需要用其他方法处理。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 判断颜色是否匹配目标颜色（带容差）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       color\_match = (</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           abs(current\_color\_rgb\[0] - color\_rgb\_target\[0]) &lt;= color\_tolerance and</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           abs(current\_color\_rgb\[1] - color\_rgb\_target\[1]) &lt;= color\_tolerance and</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           abs(current\_color\_rgb\[2] - color\_rgb\_target\[2]) &lt;= color\_tolerance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 这里没有透明度信息，所以暂时不作为判断条件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 如果你的水印是文本且颜色固定，这个方法会很有用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       if color\_match: # 仅基于颜色匹配</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           page.add\_redact\_annot(fitz.Rect(span\[&quot;bbox&quot;]), text=&quot;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 应用所有编辑</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       page.apply\_redactions()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 保存修改后的PDF</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.save(output\_pdf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.close()</span><br></pre></td></tr></table></figure></div><p><strong>代码解析</strong>：</p><ul><li><p>我们从文本跨度中提取 RGB 颜色值。</p></li><li><p>注意： 直接从 span 中提取透明度信息在 PyMuPDF 中比较复杂，因为它通常是 PDF 内容流中的图形状态参数。为了实现真正的透明度识别，你可能需要渲染页面为图像后分析像素的 alpha 通道，或者进行更复杂的 PDF 内容流解析。在上面的代码中，我暂时移除了透明度的判断，主要依赖颜色匹配。</p></li><li><p>比较提取的颜色与已知水印特征，并设置一个容差范围。</p></li></ul><p><strong>难易度</strong>：★★★★☆</p><p><strong>优点</strong>： 对具有固定颜色（特别是浅色）的水印效果好。</p><p><strong>缺点</strong>： 透明度提取是难点，可能需要深入解析 PDF 内部结构或借助图像处理库。</p><h3 id="方法三：综合多特征的水印识别-xA"><a href="#方法三：综合多特征的水印识别-xA" class="headerlink" title="方法三：综合多特征的水印识别&#xA;"></a>方法三：综合多特征的水印识别&#xA;</h3><p>当水印特征明确且固定时，这个方法能提供最高的识别准确性，因为它结合了多种特征进行判断。</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">import fitz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def remove\_watermark\_by\_multiple\_features(input\_pdf, output\_pdf,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                                         font\_size, rotation\_angle,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                                         color\_rgb,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                                         size\_tolerance=1.5, rotation\_tolerance=5.0, color\_tolerance=10):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   根据多种特征组合去除PDF中的水印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   不包含透明度参数，因为直接从text span获取透明度复杂。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   input\_pdf (str): 输入PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   output\_pdf (str): 输出PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   font\_size (float): 水印字体大小</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   rotation\_angle (float): 水印旋转角度 (度)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_rgb (tuple): 水印颜色的RGB值，如 (200, 200, 200)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   size\_tolerance (float): 字体大小匹配的容差</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   rotation\_tolerance (float): 旋转角度匹配的容差 (度)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_tolerance (int): 颜色匹配的容差 (0-255)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc = fitz.open(input\_pdf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for page in doc:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 获取页面上的所有文本和它们的属性</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       text\_infos = page.get\_text(&quot;dict&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       for block in text\_infos\[&quot;blocks&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           if &quot;lines&quot; in block:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               for line in block\[&quot;lines&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   for span in line\[&quot;spans&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 提取字体大小</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       current\_size = span\[&quot;size&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 计算旋转角度</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       matrix = fitz.Matrix(span\[&quot;matrix&quot;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       current\_rotation = math.degrees(math.atan2(matrix.b, matrix.a))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 提取颜色信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       color\_int = span\[&quot;color&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       r = (color\_int &gt;&gt; 16) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                       g = (color\_int &gt;&gt; 8) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                       b = (color\_int) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                       current\_color\_rgb = (r, g, b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 综合多个特征进行匹配</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       size\_match = abs(current\_size - font\_size) &lt; size\_tolerance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       rotation\_match = abs(current\_rotation - rotation\_angle) &lt; rotation\_tolerance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       color\_match = (</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           abs(current\_color\_rgb\[0] - color\_rgb\[0]) &lt;= color\_tolerance and</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           abs(current\_color\_rgb\[1] - color\_rgb\[1]) &lt;= color\_tolerance and</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           abs(current\_color\_rgb\[2] - color\_rgb\[2]) &lt;= color\_tolerance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 如果所有特征都匹配，则认为是水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       if size\_match and rotation\_match and color\_match:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           \# 创建一个矩形区域用于覆盖水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           page.add\_redact\_annot(fitz.Rect(span\[&quot;bbox&quot;]), text=&quot;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 应用所有编辑</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       page.apply\_redactions()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 保存修改后的PDF</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.save(output\_pdf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.close()</span><br></pre></td></tr></table></figure></div><p><strong>代码解析</strong>：</p><ul><li><p>综合提取字体大小、旋转角度和颜色三个特征（为了简化和实用性，移除了直接在 span 中获取的透明度判断）。</p></li><li><p>设置了合理的匹配容差范围，你可以根据实际情况调整这些容差值。</p></li><li><p>只有当所有选定的特征都匹配时才判定为水印，这大大提高了识别的准确性。</p></li></ul><p><strong>难易度</strong>：★★★★★</p><p><strong>优点</strong>： 识别准确性高，误判率极低。</p><p><strong>缺点</strong>： 实现相对复杂，需要精确的水印特征参数。</p><h3 id="方法四：基于文本特征的直接删除法-xA"><a href="#方法四：基于文本特征的直接删除法-xA" class="headerlink" title="方法四：基于文本特征的直接删除法&#xA;"></a>方法四：基于文本特征的直接删除法&#xA;</h3><p>如果你知道水印的具体文本内容，或者可以通过一些简单的文本属性来识别，这个方法最直接、最快速。</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">import fitz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def is\_watermark\_span(span, target\_text=None, min\_size=None, max\_size=None, target\_color\_rgb=None, color\_tolerance=10):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   判断文本跨度是否为水印，可根据实际情况自定义判断条件。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   span (dict): 文本跨度字典</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   target\_text (str): 可选，要匹配的水印文本内容</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   min\_size (float): 可选，水印字体最小尺寸</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   max\_size (float): 可选，水印字体最大尺寸</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   target\_color\_rgb (tuple): 可选，水印颜色的RGB值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_tolerance (int): 颜色匹配的容差 (0-255)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 示例：判断字体大小、颜色等特征</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 可以根据实际情况组合多个条件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 字体大小判断</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   size\_match = True</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if min\_size is not None and span\[&quot;size&quot;] &lt; min\_size:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       size\_match = False</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if max\_size is not None and span\[&quot;size&quot;] &gt; max\_size:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       size\_match = False</span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 文本内容判断</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   text\_match = True</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if target\_text is not None and target\_text.lower() not in span\[&quot;text&quot;].lower():</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       text\_match = False</span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 颜色判断</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_match = True</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if target\_color\_rgb is not None:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       color\_int = span\[&quot;color&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       r = (color\_int &gt;&gt; 16) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;       g = (color\_int &gt;&gt; 8) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;       b = color\_int &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;       current\_color\_rgb = (r, g, b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       if not (abs(current\_color\_rgb\[0] - target\_color\_rgb\[0]) &lt;= color\_tolerance and</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               abs(current\_color\_rgb\[1] - target\_color\_rgb\[1]) &lt;= color\_tolerance and</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               abs(current\_color\_rgb\[2] - target\_color\_rgb\[2]) &lt;= color\_tolerance):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           color\_match = False</span><br><span class="line"></span><br><span class="line">&amp;#x20;   return size\_match and text\_match and color\_match</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def remove\_watermark\_by\_text\_features(doc\_path, output\_path, \*\*kwargs):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   根据文本特征去除PDF中的水印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc\_path (str): 输入PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   output\_path (str): 输出PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \*\*kwargs: 传递给 is\_watermark\_span 函数的参数，如 target\_text, min\_size, max\_size, target\_color\_rgb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc = fitz.open(doc\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for page in doc:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 搜索符合水印特征的文本</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       for block in page.get\_text(&quot;dict&quot;)\[&quot;blocks&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           if block\[&quot;type&quot;] == 0:  # 文本块</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               for line in block\[&quot;lines&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   for span in line\[&quot;spans&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       if is\_watermark\_span(span,\*\* kwargs):  # 自定义判断函数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           page.add\_redact\_annot(span\[&quot;bbox&quot;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       page.apply\_redactions()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.save(output\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 示例用法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# remove\_watermark\_by\_text\_features(&quot;input.pdf&quot;, &quot;output.pdf&quot;, target\_text=&quot;CONFIDENTIAL&quot;, min\_size=10, max\_size=14, target\_color\_rgb=(204, 204, 204))</span><br></pre></td></tr></table></figure></div><p><strong>代码解析</strong>：</p><ul><li><p>通过一个可自定义的 <code>is_watermark_span</code> 函数直接搜索符合特定文本特征的水印内容。</p></li><li><p>你可以传入 <code>target_text</code>、<code>min_size</code>、<code>max_size</code> 和 <code>target_color_rgb</code> 等参数来精确定义水印的特征。</p></li><li><p>对判定为水印的文本进行覆盖处理。</p></li></ul><p><strong>难易度</strong>：★★☆☆☆</p><p><strong>优点</strong>： 实现简单，处理速度快，非常适合处理简单的文本水印。</p><p><strong>缺点</strong>： 仅适用于文本水印，无法处理图像水印。</p><h3 id="方法五：基于混合特征的高级识别法-xA"><a href="#方法五：基于混合特征的高级识别法-xA" class="headerlink" title="方法五：基于混合特征的高级识别法&#xA;"></a>方法五：基于混合特征的高级识别法&#xA;</h3><p>对于更复杂的 PDF 水印（例如包含文本和图像），这种方法结合了文本和图像特征识别，能够提供更高的识别精度。请注意，图像处理部分需要 numpy 和 opencv-python 库。</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><span class="line">import fitz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import numpy as np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import cv2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# Placeholder for actual watermark text detection logic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def is\_watermark\_text(span):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   判断文本跨度是否为水印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   你可以根据实际情况在这里实现更复杂的文本水印判断逻辑，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   例如基于字体、颜色、大小、位置、重复性等。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 示例：假设所有满足特定尺寸和颜色的文本都是水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 真实应用中，你需要更精确的逻辑</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_int = span\[&quot;color&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   r = (color\_int &gt;&gt; 16) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;   g = (color\_int &gt;&gt; 8) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;   b = color\_int &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 假设水印是浅灰色，字体较大</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if (100 &lt;= r &lt;= 220 and 100 &lt;= g &lt;= 220 and 100 &lt;= b &lt;= 220) and span\[&quot;size&quot;] &gt; 15:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       return True</span><br><span class="line"></span><br><span class="line">&amp;#x20;   return False</span><br><span class="line"></span><br><span class="line">def process\_watermark\_regions(page, text\_spans\_to\_redact, image\_regions\_to\_redact):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   处理识别到的水印区域。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 对文本水印区域进行处理</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for span\_bbox in text\_spans\_to\_redact:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       page.add\_redact\_annot(fitz.Rect(span\_bbox))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 对图像水印区域进行处理</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for region\_bbox in image\_regions\_to\_redact:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       page.add\_redact\_annot(fitz.Rect(region\_bbox))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   page.apply\_redactions()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def advanced\_watermark\_removal(doc\_path, output\_path, watermark\_template\_path=None):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   根据混合特征（文本和图像）去除PDF中的水印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc\_path (str): 输入PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   output\_path (str): 输出PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   watermark\_template\_path (str): 可选，水印图像模板的路径，用于SIFT特征匹配。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc = fitz.open(doc\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   watermark\_template = None</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if watermark\_template\_path:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# Load watermark template in grayscale for SIFT</span><br><span class="line"></span><br><span class="line">&amp;#x20;       watermark\_template = cv2.imread(watermark\_template\_path, cv2.IMREAD\_GRAYSCALE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       if watermark\_template is None:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           print(f&quot;警告：无法加载水印模板图像：&#123;watermark\_template\_path&#125;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           watermark\_template\_path = None # Disable image matching if template fails to load</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   sift = cv2.SIFT\_create()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   kp1, des1 = None, None</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if watermark\_template\_path and watermark\_template is not None:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       kp1, des1 = sift.detectAndCompute(watermark\_template, None)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for page in doc:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       text\_spans\_to\_redact = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       image\_regions\_to\_redact = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 第一步：文本特征识别</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       text\_infos = page.get\_text(&quot;dict&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       for block in text\_infos\[&quot;blocks&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           if &quot;lines&quot; in block:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               for line in block\[&quot;lines&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   for span in line\[&quot;spans&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       if is\_watermark\_text(span): # 检查字体/颜色等</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                           text\_spans\_to\_redact.append(span\[&quot;bbox&quot;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 第二步：图像特征识别 (如果提供了水印模板)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       if watermark\_template\_path and watermark\_template is not None and des1 is not None:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           pix = page.get\_pixmap(matrix=fitz.Matrix(2,2)) # 提高渲染分辨率以便更好的特征检测</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           img = cv2.cvtColor(np.frombuffer(pix.samples, np.uint8).reshape(</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               pix.h, pix.w, pix.n), cv2.COLOR\_RGB2GRAY) # 转为灰度图进行特征检测</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           kp2, des2 = sift.detectAndCompute(img, None)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           if des2 is not None and len(des1) &gt; 0 and len(des2) &gt; 0:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               \# 特征匹配</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               matcher = cv2.BFMatcher()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               matches = matcher.knnMatch(des1, des2, k=2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;              &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               \# 筛选良好的匹配点</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               good\_matches = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               for m, n in matches:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   if m.distance &lt; 0.75 \* n.distance: # 0.75是经验值，可调</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       good\_matches.append(m)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;              &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               \# 如果匹配点足够多，则认为存在图像水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               if len(good\_matches) &gt; 10: # 至少需要10个好的匹配点</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   \# 尝试找到水印在页面上的大致位置</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   src\_pts = np.float32(\[kp1\[m.queryIdx].pt for m in good\_matches]).reshape(-1, 1, 2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   dst\_pts = np.float32(\[kp2\[m.trainIdx].pt for m in good\_matches]).reshape(-1, 1, 2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   \# 使用 findHomography 找到变换矩阵</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   M, mask = cv2.findHomography(src\_pts, dst\_pts, cv2.RANSAC, 5.0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   if M is not None:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       h, w = watermark\_template.shape</span><br><span class="line"></span><br><span class="line">&amp;#x20;                       pts = np.float32(\[\[0, 0], \[0, h-1], \[w-1, h-1], \[w-1, 0]]).reshape(-1, 1, 2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 应用变换矩阵，得到水印在页面上的四个角点</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       dst = cv2.perspectiveTransform(pts, M)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       \# 计算水印区域的边界框</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       min\_x = int(np.min(dst\[:, 0, 0]) / pix.matrix.a) # 还原到原始PDF坐标</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       min\_y = int(np.min(dst\[:, 0, 1]) / pix.matrix.d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       max\_x = int(np.max(dst\[:, 0, 0]) / pix.matrix.a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       max\_y = int(np.max(dst\[:, 0, 1]) / pix.matrix.d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                       image\_regions\_to\_redact.append((min\_x, min\_y, max\_x, max\_y))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 综合处理文本和图像水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       process\_watermark\_regions(page, text\_spans\_to\_redact, image\_regions\_to\_redact)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.save(output\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 示例用法（需要准备一个 watermark\_template.png 图片作为水印模板）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# advanced\_watermark\_removal(&quot;input.pdf&quot;, &quot;output.pdf&quot;, &quot;watermark\_template.png&quot;)</span><br></pre></td></tr></table></figure></div><p><strong>代码解析</strong>：</p><ul><li><p><strong>文本特征识别</strong>： 沿用了之前 <code>is_watermark_text</code> 的概念，但你需要根据实际水印特性来完善这个逻辑。</p></li><li><p><strong>图像特征识别</strong>：</p><ul><li><p>将 PDF 页面渲染为图像，并转换为灰度图，以便进行特征检测。</p></li><li><p>使用 SIFT 算法（或其他特征匹配算法如 ORB, SURF）来检测并匹配图像水印模板。</p></li><li><p>通过 <code>findHomography</code> 计算水印在页面上的变换，从而确定水印的精确位置和边界框。</p></li><li><p>注意： 图像处理库 (如 OpenCV) 通常在像素坐标系下操作，你需要将检测到的像素坐标转换回 PyMuPDF 使用的 PDF 坐标。</p></li></ul></li><li><p><strong>综合处理</strong>： 将文本和图像识别的结果结合起来，对所有识别出的水印区域进行处理。</p></li></ul><p><strong>难易度</strong>：★★★★☆</p><p><strong>优点</strong>： 识别精度高，适用于复杂水印环境（文本与图像混合），鲁棒性强。</p><p><strong>缺点</strong>： 实现复杂，需要水印模板，处理速度相对较慢，需要额外的图像处理库。</p><h3 id="方法六：基于-PDF-底层结构的终极方案-xA"><a href="#方法六：基于-PDF-底层结构的终极方案-xA" class="headerlink" title="方法六：基于 PDF 底层结构的终极方案&#xA;"></a>方法六：基于 PDF 底层结构的终极方案&#xA;</h3><p>这种方法最为彻底，因为它直接操作 PDF 文件的底层结构。但它也要求你对 PDF 规范有深入的了解，操作不当可能会导致文件损坏。</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">import fitz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def deep\_watermark\_removal(doc\_path, output\_path):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   通过直接操作PDF的XObject和内容流，尝试去除水印。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   这是一种更底层、更彻底的方式，但需要对PDF结构有一定了解。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   注意：此方法可能非常具体，不适用于所有水印类型，且操作不当可能损坏PDF。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc = fitz.open(doc\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for page\_num, page in enumerate(doc):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 尝试通过删除XObject（外部对象，可能是图像或Form XObject）来去除水印</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 这需要猜测哪些XObject是水印。通常水印是透明的或在底层。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# PyMuPDF没有直接的 delete\_object 方法，通常的做法是重新构建内容流或用add\_redact\_annot。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 如果水印是作为独立XObject嵌入的，你可以尝试识别并替换页面内容流中对它们的引用。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 这是一个非常高级且风险高的操作，这里我们不直接修改XObject，而是依赖redaction。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 另一种思路是检查页面内容流中是否存在特定的操作符，例如设置透明度或特定颜色。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 但这需要更深入的解析内容流。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 目前PyMuPDF没有直接暴露修改/删除底层XObject的API，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# add\_redact\_annot 是最安全和推荐的方式来“删除”页面内容。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 如果水印是文本，可以结合方法1-4来识别。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 如果水印是图像，但不是作为XObject直接插入，而是作为背景，则需要渲染后处理。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 示例：尝试查找并删除名称中可能包含“Watermark”的Form XObject引用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 这是一个象征性的操作，实际操作会复杂得多。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 获取页面的内容流</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#contents = page.get\_contents() # 这是内容流的列表，每个元素是一个对象ID</span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#for item\_id in contents:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#    item\_obj = doc.get\_pdf\_object(item\_id) # 获取实际的PDF对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#    if item\_obj:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        content\_bytes = item\_obj.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # 检查内容流中是否有水印相关的指令，例如 /DeviceGray Cs, /CA 0.x, /ca 0.x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # 这是一个高度定制化的过程，取决于水印是如何被创建的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # 通常水印文本会使用特定的字体、颜色和透明度设置。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # 我们可以尝试替换掉这些设置或其相关的文本/图像绘图指令。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # 例如，如果水印被标记为 /Watermark，可以尝试移除这个标记</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # 警告：直接修改内容流非常危险，可能导致PDF损坏。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # content\_stream = content\_bytes.replace(b&quot;/Watermark&quot;, b&quot;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # 如果内容流对象是可写的，可以尝试更新它</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        # doc.update\_object(item\_id, content\_stream)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \#        pass # 实际不执行直接修改，而是使用更安全的redaction</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 由于PyMuPDF没有直接删除XObject的简单API，并且直接修改内容流风险高，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 这种“终极方案”通常指的是在更底层的PDF解析库中实现。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 在PyMuPDF的语境下，最安全和推荐的“底层”处理是使用 redact\_annot 来覆盖。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 如果水印是作为 Form XObject 嵌入，且它们是半透明的，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# PyMuPDF 的 page.get\_text(&quot;dict&quot;) 或 page.get\_images() 可能无法直接识别。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 此时，可能需要：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 1. 遍历页面所有对象（PyMuPDF不直接提供此功能，除非通过高级解析）。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 2. 渲染页面并进行图像处理，识别水印区域，然后进行 redact。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;      &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 总结：此方法在PyMuPDF中实现非常困难且不推荐，除非对PDF内部结构有极深理解。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 推荐使用前面更安全、更易于控制的基于特征的redaction方法。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 为了让这个函数有实际意义，我们可以让它在非常明确的情况下执行redaction</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 例如，如果你知道水印是某个特定名称的Form XObject，但通常PyMuPDF不直接暴露这个</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       print(f&quot;Warning: Method 6 (deep\_watermark\_removal) in PyMuPDF is generally not feasible for direct object deletion without significant PDF internal structure parsing and modification, which is outside the scope of simple PyMuPDF APIs. Using redaction is the recommended safe approach.&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 如果水印是透明度很高的图像，可能需要渲染页面然后用图像处理来识别并redact</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 这里为了避免误导，不提供具体实现，仅保留框架。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.save(output\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.close()</span><br></pre></td></tr></table></figure></div><p><strong>代码解析</strong>：</p><ul><li><p>这个方法旨在直接操作 PDF 的 XObject (外部对象，可以是图像或 Form XObject) 和内容流。</p></li><li><p><strong>重要提示</strong>： PyMuPDF (Fitz) 并没有直接暴露修改或删除底层 PDF 对象的 API。 <code>add_redact_annot</code> 是 PyMuPDF 中最安全和推荐的方式来 “删除” 页面内容的。直接修改 PDF 的底层内容流非常危险，操作不当很可能导致 PDF 文件损坏且无法打开。</p></li><li><p>因此，我调整了此方法的描述和代码示例，强调其复杂性和风险，并指出在 PyMuPDF 中，更推荐使用 <code>add_redact_annot</code> 来实现 “删除” 效果。如果你真的需要深入到 PDF 底层修改，可能需要更专业的 PDF 处理库或对 PDF 规范有极其深入的了解。</p></li></ul><p><strong>难易度</strong>：★★★★★ (理论上)</p><p><strong>优点</strong>： 理论上可以彻底清除不留痕迹，适用于各种类型水印。</p><p><strong>缺点</strong>： 实现非常复杂，需要深入的 PDF 结构知识，且在 PyMuPDF 中直接实现此类操作难度极高且风险大。</p><p>方法对比与选择建议</p><table><thead><tr><th>方法&#xA;</th><th>难易度&#xA;</th><th>适用场景&#xA;</th><th>关键优势&#xA;</th><th>局限性&#xA;</th></tr></thead><tbody><tr><td>字体大小 + 旋转角度&#xA;</td><td>★★★☆☆&#xA;</td><td>水印有固定大小和倾斜角度&#xA;</td><td>实现相对简单，识别准确率较高&#xA;</td><td>需要精确的大小和角度参数&#xA;</td></tr><tr><td>透明度 + 颜色&#xA;</td><td>★★★★☆&#xA;</td><td>水印有固定颜色（特别是浅色）&#xA;</td><td>对浅色水印效果好&#xA;</td><td>透明度提取是难点，可能需要深入解析 PDF 内部结构或借助图像处理库&#xA;</td></tr><tr><td>多特征综合&#xA;</td><td>★★★★★&#xA;</td><td>水印特征明确且固定&#xA;</td><td>识别准确性高，误判率极低&#xA;</td><td>实现相对复杂，需要精确的水印特征参数&#xA;</td></tr><tr><td>基于文本特征&#xA;</td><td>★★☆☆☆&#xA;</td><td>简单文本水印&#xA;</td><td>实现简单，处理速度快&#xA;</td><td>仅适用于文本水印，无法处理图像水印&#xA;</td></tr><tr><td>混合特征识别&#xA;</td><td>★★★★☆&#xA;</td><td>复杂水印环境（文本与图像混合）&#xA;</td><td>识别精度高&#xA;</td><td>实现复杂，需要水印模板，处理速度慢&#xA;</td></tr><tr><td>底层结构处理&#xA;</td><td>★★★★★&#xA;</td><td>各种类型水印&#xA;</td><td>理论上最彻底&#xA;</td><td>高风险，PyMuPDF 中难以直接实现，需要深厚知识&#xA;</td></tr></tbody></table><p>特征参数提取方法</p><p>在实际应用中，我们首先需要获取水印的特征参数。可以通过以下方式初步提取：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">import fitz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from collections import Counter</span><br><span class="line"></span><br><span class="line">def extract\_watermark\_features(pdf\_path, page\_num=0):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   尝试提取PDF页面中可能的水印文本特征。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   此函数会返回页面中最常见的字体大小、旋转角度和颜色。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   这仅是一个初步分析工具，对于复杂水印可能需要人工确认或更复杂的统计。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   pdf\_path (str): PDF文件路径</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   page\_num (int): 要分析的页面编号 (默认为第一页)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   返回:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   dict: 包含可能的水印特征的字典，如 &quot;font\_size&quot;, &quot;rotation\_angle&quot;, &quot;color\_rgb&quot;, &quot;opacity&quot;(占位)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc = fitz.open(pdf\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   page = doc\[page\_num]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 用于存储可能的水印特征</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   possible\_font\_sizes = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   possible\_rotations = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   possible\_colors = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 获取页面上的所有文本和它们的属性</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   text\_infos = page.get\_text(&quot;dict&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for block in text\_infos\[&quot;blocks&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       if &quot;lines&quot; in block:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           for line in block\[&quot;lines&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               for span in line\[&quot;spans&quot;]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   \# 提取字体大小</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   possible\_font\_sizes.append(round(span\[&quot;size&quot;], 1)) # 四舍五入到小数点后1位，便于统计</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   \# 计算旋转角度</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   matrix = fitz.Matrix(span\[&quot;matrix&quot;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   rotation = round(math.degrees(math.atan2(matrix.b, matrix.a)), 1) # 四舍五入，便于统计</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   possible\_rotations.append(rotation)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   \# 提取颜色信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   color\_int = span\[&quot;color&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;                   r = (color\_int &gt;&gt; 16) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                   g = (color\_int &gt;&gt; 8) &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                   b = color\_int &amp; 0xFF</span><br><span class="line"></span><br><span class="line">&amp;#x20;                   possible\_colors.append((r, g, b))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 简单分析：找出最常见的特征值作为水印特征</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \# 实际应用中可能需要更复杂的聚类分析或人工确认</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;  &amp;#x20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   font\_size = None</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if possible\_font\_sizes:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       font\_size = Counter(possible\_font\_sizes).most\_common(1)\[0]\[0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   rotation\_angle = None</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if possible\_rotations:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       rotation\_angle = Counter(possible\_rotations).most\_common(1)\[0]\[0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 旋转角度可能为负，将其规范化到 0-360 度</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       if rotation\_angle &lt; 0:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           rotation\_angle += 360</span><br><span class="line"></span><br><span class="line">&amp;#x20;   color\_rgb = None</span><br><span class="line"></span><br><span class="line">&amp;#x20;   if possible\_colors:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       color\_rgb = Counter(possible\_colors).most\_common(1)\[0]\[0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   doc.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   return &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &quot;font\_size&quot;: font\_size,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &quot;rotation\_angle&quot;: rotation\_angle,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &quot;color\_rgb&quot;: color\_rgb,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &quot;opacity&quot;: 0.5  # 这是一个示例值，实际中透明度提取非常复杂，需要手动确认或更高级分析</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 示例用法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# features = extract\_watermark\_features(&quot;your\_watermarked\_document.pdf&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# print(features)</span><br></pre></td></tr></table></figure></div><p><strong>代码解析</strong>：</p><ul><li><p>此函数会遍历指定页面的所有文本跨度，收集它们的字体大小、旋转角度和颜色。</p></li><li><p>为了方便统计，对浮点数（大小和角度）进行了四舍五入。</p></li><li><p>使用 <code>collections.Counter</code> 找出最常见的字体大小、旋转角度和颜色，作为可能的水印特征。</p></li><li><p>注意： 提取透明度仍然是一个挑战，<code>opacity</code> 参数在此处仍作为占位符，需要通过其他方式（例如手动观察或更复杂的 PDF 内容流解析）来确定。</p></li></ul><p>总结与最佳实践</p><p>基于特征的 PDF 水印处理方法能够实现更精确的水印识别和去除，但这要求你对水印的特征有充分了解。在实际应用中，我建议你遵循以下最佳实践：</p><ol><li><p><strong>预处理分析</strong>： 首先使用 <code>extract_watermark_features</code> 函数分析水印特征，初步了解水印的字体大小、旋转角度、颜色等关键信息。必要时，手工观察水印，确认其透明度、具体文本内容或图像样式。</p></li><li><p><strong>从简到繁尝试</strong>： 从最简单的方法开始。如果水印是纯文本且特征明显，可以先尝试 基于文本特征的直接删除法。如果水印有固定的字体大小和倾斜角度，就用 基于字体大小和旋转角度的方法。只有当简单方法效果不佳时，再逐步增加特征维度，尝试 多特征综合识别。</p></li><li><p><strong>合理调整参数</strong>： 根据实际水印情况细致调整匹配容差值，在识别准确率和误判率之间取得最佳平衡。例如，对于字体大小，可以允许 1.0 到 2.0 的误差范围；对于旋转角度，可允许 3 到 5 度左右的误差。</p></li><li><p><strong>复杂场景组合</strong>： 对于包含多种类型水印的复杂 PDF，考虑结合多种方法进行处理。例如，对于既有文本又有图像的混合水印，可以结合 混合特征识别法。</p></li><li><p><strong>批量处理技巧</strong>： 如果你需要处理大量 PDF 文件，利用多线程或多进程可以显著提高处理效率。</p></li></ol><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">from concurrent.futures import ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def batch\_process\_pdfs(file\_list, output\_dir, \*\*watermark\_params):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   批量处理PDF文件，使用多线程提高效率。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   参数:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   file\_list (list): 包含所有待处理PDF文件路径的列表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   output\_dir (str): 处理后PDF文件的输出目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \*\*watermark\_params: 传递给 remove\_watermark\_by\_multiple\_features 的水印特征参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   os.makedirs(output\_dir, exist\_ok=True) # 确保输出目录存在</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   with ThreadPoolExecutor(max\_workers=os.cpu\_count()) as executor: # 使用CPU核心数作为最大工作线程数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       futures = \[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       for file\_path in file\_list:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           file\_name = os.path.basename(file\_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           output\_path = os.path.join(output\_dir, file\_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           \# 提交任务到线程池</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           futures.append(executor.submit(</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               remove\_watermark\_by\_multiple\_features,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               file\_path, output\_path,\*\* watermark\_params</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           ))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \# 等待所有任务完成</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       for future in futures:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           try:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               future.result() # 获取结果，如果任务有异常会在这里抛出</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               print(f&quot;文件处理完成：&#123;file\_path&#125;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           except Exception as exc:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;               print(f&quot;文件 &#123;file\_path&#125; 处理时发生错误：&#123;exc&#125;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 示例用法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# pdf\_files\_to\_process = \[&quot;doc1.pdf&quot;, &quot;doc2.pdf&quot;] # 你的PDF文件列表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# output\_folder = &quot;processed\_pdfs&quot;</span><br><span class="line"></span><br><span class="line">\# watermark\_features = &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#     &quot;font\_size&quot;: 36.0,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#     &quot;rotation\_angle&quot;: 30.0,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\#     &quot;color\_rgb&quot;: (192, 192, 192) # 浅灰色</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# batch\_process\_pdfs(pdf\_files\_to\_process, output\_folder, \*\*watermark\_features)</span><br></pre></td></tr></table></figure></div><ol><li><strong>操作安全保障</strong>： 在处理任何重要文件之前，务必先备份原始文件！这能确保即使处理不当，你也不会丢失原始数据。同时，请始终遵守相关法律法规，仅处理你有权修改的文档，尊重知识产权和版权保护。</li></ol><p>通过合理选择和组合这些方法，你就能高效且精准地处理各种具有特定特征的 PDF 水印。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在日常工作中，我们经常会遇到带有特定特征的 PDF 水印，比如固定的字体大小、倾斜角度、透明度和颜色。这些特性为我们提供了更精准地识别水印的依据。今天，我们就来深入探讨如何利用 PyMuPDF (Fitz) 库，基于这些特征实现 PDF 水印的精确识别和去除，并整合多种实用</summary>
      
    
    
    
    <category term="PDF 处理" scheme="http://example.com/categories/PDF-%E5%A4%84%E7%90%86/"/>
    
    <category term="Python" scheme="http://example.com/categories/PDF-%E5%A4%84%E7%90%86/Python/"/>
    
    <category term="数据处理" scheme="http://example.com/categories/PDF-%E5%A4%84%E7%90%86/Python/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/"/>
    
    
    <category term="Python" scheme="http://example.com/tags/Python/"/>
    
    <category term="PyMuPDF" scheme="http://example.com/tags/PyMuPDF/"/>
    
    <category term="PDF" scheme="http://example.com/tags/PDF/"/>
    
    <category term="水印去除" scheme="http://example.com/tags/%E6%B0%B4%E5%8D%B0%E5%8E%BB%E9%99%A4/"/>
    
    <category term="特征识别" scheme="http://example.com/tags/%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB/"/>
    
    <category term="文本处理" scheme="http://example.com/tags/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>从零开始的爬虫生活（一）：环境搭建与基础库应用</title>
    <link href="http://example.com/2025/07/15/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84%E7%88%AC%E8%99%AB%E7%94%9F%E6%B4%BB%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%9F%BA%E7%A1%80%E5%BA%93%E5%BA%94%E7%94%A8/"/>
    <id>http://example.com/2025/07/15/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84%E7%88%AC%E8%99%AB%E7%94%9F%E6%B4%BB%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%9F%BA%E7%A1%80%E5%BA%93%E5%BA%94%E7%94%A8/</id>
    <published>2025-07-15T09:15:15.000Z</published>
    <updated>2025-07-16T01:50:53.379Z</updated>
    
    <content type="html"><![CDATA[<p>从零开始的爬虫生活（一）：环境搭建与基础库应用</p><p>一、环境搭建</p><p>在开始学习爬虫之前，我们需要先搭建好开发环境。以下是一些常用的工具和库：</p><h3 id="1-Python-环境-xA"><a href="#1-Python-环境-xA" class="headerlink" title="1. Python 环境&#xA;"></a>1. Python 环境&#xA;</h3><p>确保已经安装了 Python 3.x 版本。可以前往 <a class="link"   href="https://www.python.org/" >Python 官网<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 下载安装。</p><h3 id="2-常用库安装-xA"><a href="#2-常用库安装-xA" class="headerlink" title="2. 常用库安装&#xA;"></a>2. 常用库安装&#xA;</h3><p>使用 pip 命令安装以下库：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pip install selenium</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pip install beautifulsoup4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pip install pyquery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pip install pymysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pip install pymongo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pip install redis</span><br></pre></td></tr></table></figure></div><h3 id="3-浏览器驱动-xA"><a href="#3-浏览器驱动-xA" class="headerlink" title="3. 浏览器驱动&#xA;"></a>3. 浏览器驱动&#xA;</h3><ul><li><p><strong>ChromeDriver</strong>：根据你使用的 Chrome 浏览器版本，下载对应的 ChromeDriver。</p></li><li><p><strong>PhantomJS（已弃用）</strong>：在 Selenium 4.x 中已移除，建议使用无头模式的 Chrome。</p></li></ul><p><strong>配置 Chrome 无头模式示例：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">from selenium import webdriver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from selenium.webdriver.chrome.options import Options</span><br><span class="line"></span><br><span class="line">\# 配置 Chrome 为无头模式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chrome\_options = Options()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chrome\_options.add\_argument(&quot;--headless&quot;)  # 无头模式，不显示浏览器窗口</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# 创建 Chrome 浏览器实例</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">driver = webdriver.Chrome(options=chrome\_options)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">driver.get(&quot;https://www.example.com&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(driver.title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">driver.quit()</span><br></pre></td></tr></table></figure></div><p>二、基础库应用</p><h3 id="1-BeautifulSoup-库-xA"><a href="#1-BeautifulSoup-库-xA" class="headerlink" title="1. BeautifulSoup 库&#xA;"></a>1. BeautifulSoup 库&#xA;</h3><p>BeautifulSoup 是一个用于解析 HTML 和 XML 文档的库。<strong>示例：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">from bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line">html\_doc = &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\&lt;html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \&lt;title&gt;示例页面\&lt;/title&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;/head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \&lt;h1&gt;标题\&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \&lt;p&gt;段落内容\&lt;/p&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;/body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">soup = BeautifulSoup(html\_doc, &#x27;html.parser&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(soup.title.string)  # 输出标题内容</span><br></pre></td></tr></table></figure></div><h3 id="2-PyQuery-库-xA"><a href="#2-PyQuery-库-xA" class="headerlink" title="2. PyQuery 库&#xA;"></a>2. PyQuery 库&#xA;</h3><p>PyQuery 是一个类 jQuery 的 Python 库，用于操作 HTML 文档。<strong>示例：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from pyquery import PyQuery as pq</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">html\_doc = &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\&lt;html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \&lt;title&gt;示例页面\&lt;/title&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;/head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \&lt;h1&gt;标题\&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       \&lt;p&gt;段落内容\&lt;/p&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   \&lt;/body&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">doc = pq(html\_doc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(doc(&#x27;title&#x27;).text())  # 输出标题内容</span><br></pre></td></tr></table></figure></div><h3 id="3-Requests-库-xA"><a href="#3-Requests-库-xA" class="headerlink" title="3. Requests 库&#xA;"></a>3. Requests 库&#xA;</h3><p>Requests 是一个简单的 HTTP 库，用于发送网络请求。<strong>示例：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = &quot;https://www.example.com&quot;</span><br><span class="line"></span><br><span class="line">response = requests.get(url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(response.text)  # 输出网页内容</span><br></pre></td></tr></table></figure></div><p>三、数据存储</p><h3 id="1-MySQL-数据库-xA"><a href="#1-MySQL-数据库-xA" class="headerlink" title="1. MySQL 数据库&#xA;"></a>1. MySQL 数据库&#xA;</h3><p>使用 PyMySQL 连接和操作 MySQL 数据库：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import pymysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   host=&#x27;localhost&#x27;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   user=&#x27;root&#x27;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   password=&#x27;123456&#x27;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   port=3306,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   db=&#x27;mysql&#x27;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cursor.execute(&#x27;SELECT \* FROM db&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(cursor.fetchone())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure></div><h3 id="2-MongoDB-数据库-xA"><a href="#2-MongoDB-数据库-xA" class="headerlink" title="2. MongoDB 数据库&#xA;"></a>2. MongoDB 数据库&#xA;</h3><p>使用 PyMongo 连接和操作 MongoDB 数据库：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import pymongo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client = pymongo.MongoClient(&#x27;localhost&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db = client\[&#x27;newtestdb&#x27;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db\[&#x27;table&#x27;].insert\_one(&#123;&#x27;name&#x27;: &#x27;Bob&#x27;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = db\[&#x27;table&#x27;].find\_one(&#123;&#x27;name&#x27;: &#x27;Bob&#x27;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure></div><h3 id="3-Redis-数据库-xA"><a href="#3-Redis-数据库-xA" class="headerlink" title="3. Redis 数据库&#xA;"></a>3. Redis 数据库&#xA;</h3><p>使用 RedisPy 连接和操作 Redis 数据库：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = redis.Redis(&#x27;localhost&#x27;, 6379)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.set(&#x27;name&#x27;, &#x27;Bob&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = r.get(&#x27;name&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure></div><p>四、爬虫基本流程</p><p>爬虫的基本流程如下：</p><ol><li><p>发送请求：使用 Requests 库发送 HTTP 请求获取网页内容。</p></li><li><p>解析响应：使用 BeautifulSoup 或 PyQuery 库解析网页内容，提取所需数据。</p></li><li><p>保存数据：将提取的数据存储到数据库或文件中。</p></li></ol><p><strong>示例：爬取猫眼电影 TOP100</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from multiprocessing import Pool</span><br><span class="line"></span><br><span class="line">def get\_one\_page(url):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   headers = &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#x27;User-Agent&#x27;: &#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36 Edg/137.0.0.0&#x27;</span><br><span class="line"></span><br><span class="line">&amp;#x20;   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   response = requests.get(url, headers=headers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   if response.status\_code == 200:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       return response.text</span><br><span class="line"></span><br><span class="line">&amp;#x20;   return None</span><br><span class="line"></span><br><span class="line">def parse\_one\_page(html):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   pattern = re.compile(&#x27;\&lt;dd&gt;.\*?board-index.\*?&gt;(\d+)\&lt;/i&gt;.\*?data-src=&quot;(.\*?)&quot;.\*?name&quot;&gt;\&lt;a&#x27;</span><br><span class="line"></span><br><span class="line">&amp;#x20;                        \+ &#x27;.\*?&gt;(.\*?)\&lt;/a&gt;.\*?star&quot;&gt;(.\*?)\&lt;/p&gt;.\*?releasetime&quot;&gt;(.\*?)\&lt;/p&gt;&#x27;</span><br><span class="line"></span><br><span class="line">&amp;#x20;                        \+ &#x27;.\*?integer&quot;&gt;(.\*?)\&lt;/i&gt;.\*?fraction&quot;&gt;(.\*?)\&lt;/i&gt;.\*?\&lt;/dd&gt;&#x27;, re.S)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   items = re.findall(pattern, html)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for item in items:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       yield &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;index&#x27;: item\[0],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;image&#x27;: item\[1],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;title&#x27;: item\[2],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;actor&#x27;: item\[3].strip()\[3:],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;time&#x27;: item\[4].strip()\[5:],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;           &#x27;score&#x27;: item\[5] + item\[6]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def write\_to\_file(content):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   with open(&#x27;result.txt&#x27;, &#x27;a&#x27;, encoding=&#x27;utf-8&#x27;) as f:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       f.write(json.dumps(content, ensure\_ascii=False) + &#x27;\n&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main(offset):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   url = &#x27;http://maoyan.com/board/4?offset=&#x27; + str(offset)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   html = get\_one\_page(url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   for item in parse\_one\_page(html):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       print(item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;       write\_to\_file(item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if \_\_name\_\_ == &#x27;\_\_main\_\_&#x27;:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   pool = Pool()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;#x20;   pool.map(main, \[i \* 10 for i in range(10)])</span><br></pre></td></tr></table></figure></div><p>五、动态网页处理</p><p>对于动态加载的网页，可以使用 Selenium 模拟浏览器操作。<strong>示例：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from selenium import webdriver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from selenium.webdriver.common.by import By</span><br><span class="line"></span><br><span class="line">driver = webdriver.Chrome()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">driver.get(&#x27;https://www.taobao.com&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input = driver.find\_element(By.ID, &#x27;q&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input.send\_keys(&#x27;美食&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">button = driver.find\_element(By.CLASS\_NAME, &#x27;btn-search&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">button.click()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">driver.quit()</span><br></pre></td></tr></table></figure></div><p>六、爬虫框架</p><h3 id="1-Scrapy-框架-xA"><a href="#1-Scrapy-框架-xA" class="headerlink" title="1. Scrapy 框架&#xA;"></a>1. Scrapy 框架&#xA;</h3><p>Scrapy 是一个强大的爬虫框架，可以简化爬虫开发过程。<strong>安装命令：</strong></p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install scrapy</span><br></pre></td></tr></table></figure></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;从零开始的爬虫生活（一）：环境搭建与基础库应用&lt;/p&gt;
&lt;p&gt;一、环境搭建&lt;/p&gt;
&lt;p&gt;在开始学习爬虫之前，我们需要先搭建好开发环境。以下是一些常用的工具和库：&lt;/p&gt;
&lt;h3 id=&quot;1-Python-环境-xA&quot;&gt;&lt;a href=&quot;#1-Python-环境-xA&quot; c</summary>
      
    
    
    
    <category term="爬虫教程" scheme="http://example.com/categories/%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Python爬虫" scheme="http://example.com/tags/Python%E7%88%AC%E8%99%AB/"/>
    
    <category term="数据抓取" scheme="http://example.com/tags/%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96/"/>
    
    <category term="Selenium" scheme="http://example.com/tags/Selenium/"/>
    
    <category term="BeautifulSoup" scheme="http://example.com/tags/BeautifulSoup/"/>
    
    <category term="数据存储" scheme="http://example.com/tags/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/"/>
    
  </entry>
  
  <entry>
    <title>Dify镜像源替换与服务启动</title>
    <link href="http://example.com/2025/07/15/Dify-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%EF%BC%9A%E9%95%9C%E5%83%8F%E6%BA%90%E6%9B%BF%E6%8D%A2%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/"/>
    <id>http://example.com/2025/07/15/Dify-%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%EF%BC%9A%E9%95%9C%E5%83%8F%E6%BA%90%E6%9B%BF%E6%8D%A2%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/</id>
    <published>2025-07-15T02:17:31.000Z</published>
    <updated>2025-07-16T01:50:52.195Z</updated>
    
    <content type="html"><![CDATA[<p>Dify 部署流程：镜像源替换与服务启动</p><p>一、Dify 镜像源替换操作</p><h3 id="批量替换镜像前缀-xA"><a href="#批量替换镜像前缀-xA" class="headerlink" title="批量替换镜像前缀&#xA;"></a>批量替换镜像前缀&#xA;</h3><p>在 docker-compose.yaml 所在目录执行全局替换，添加 docker.1ms.run&#x2F; 前缀：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/image: /image: docker.1ms.run\\//g&#x27; docker-compose.yaml</span><br></pre></td></tr></table></figure></div><h3 id="特殊镜像路径修正-xA"><a href="#特殊镜像路径修正-xA" class="headerlink" title="特殊镜像路径修正&#xA;"></a>特殊镜像路径修正&#xA;</h3><h4 id="问题路径-xA"><a href="#问题路径-xA" class="headerlink" title="问题路径&#xA;"></a>问题路径&#xA;</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image: docker.1ms.run/docker.elastic.co/elasticsearch/elasticsearch:8.14.3</span><br></pre></td></tr></table></figure></div><h4 id="修正命令-xA"><a href="#修正命令-xA" class="headerlink" title="修正命令&#xA;"></a>修正命令&#xA;</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s|docker.1ms.run/docker.elastic.co/|docker.1ms.run/elastic/|g&#x27; docker-compose.yaml</span><br></pre></td></tr></table></figure></div><h4 id="正确路径-xA"><a href="#正确路径-xA" class="headerlink" title="正确路径&#xA;"></a>正确路径&#xA;</h4><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image: docker.1ms.run/elastic/elasticsearch:8.14.3</span><br></pre></td></tr></table></figure></div><h3 id="基础镜像补充替换-xA"><a href="#基础镜像补充替换-xA" class="headerlink" title="基础镜像补充替换&#xA;"></a>基础镜像补充替换&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s|image: postgres:|image: docker.1ms.run/postgres:|g&#x27; docker-compose.yaml</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s|image: redis:|image: docker.1ms.run/redis:|g&#x27; docker-compose.yaml</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s|image: nginx:|image: docker.1ms.run/nginx:|g&#x27; docker-compose.yaml</span><br></pre></td></tr></table></figure></div><p>二、部署前准备工作</p><p>赋予挂载目录权限：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 ./volumes ./elasticsearch</span><br></pre></td></tr></table></figure></div><p>三、启动与验证 Dify 服务</p><h3 id="后台启动服务-xA"><a href="#后台启动服务-xA" class="headerlink" title="后台启动服务&#xA;"></a>后台启动服务&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></div><h3 id="验证服务状态-xA"><a href="#验证服务状态-xA" class="headerlink" title="验证服务状态&#xA;"></a>验证服务状态&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps  # 检查容器运行状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker-compose logs -f  # 查看实时日志</span><br></pre></td></tr></table></figure></div><h3 id="访问-Dify-界面-xA"><a href="#访问-Dify-界面-xA" class="headerlink" title="访问 Dify 界面&#xA;"></a>访问 Dify 界面&#xA;</h3><p>浏览器输入 http:&#x2F;&#x2F; 服务器 IP:3000，默认账号 <a class="link"   href="mailto:&#97;&#x64;&#x6d;&#105;&#x6e;&#64;&#101;&#120;&#x61;&#x6d;&#112;&#x6c;&#x65;&#46;&#x63;&#111;&#x6d;" >admin@example.com<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，密码 password。</p><p>四、部署过程常见问题</p><h3 id="镜像路径嵌套错误-xA"><a href="#镜像路径嵌套错误-xA" class="headerlink" title="镜像路径嵌套错误&#xA;"></a>镜像路径嵌套错误&#xA;</h3><h4 id="问题-xA"><a href="#问题-xA" class="headerlink" title="问题&#xA;"></a>问题&#xA;</h4><p>镜像路径包含 docker.1ms.run&#x2F;docker.elastic.co&#x2F; 嵌套结构。</p><h4 id="解决-xA"><a href="#解决-xA" class="headerlink" title="解决&#xA;"></a>解决&#xA;</h4><p>使用 sed 精准替换：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s|docker.1ms.run/docker.elastic.co/|docker.1ms.run/elastic/|g&#x27; docker-compose.yaml</span><br></pre></td></tr></table></figure></div><h3 id="权限不足导致启动失败-xA"><a href="#权限不足导致启动失败-xA" class="headerlink" title="权限不足导致启动失败&#xA;"></a>权限不足导致启动失败&#xA;</h3><h4 id="问题-xA-1"><a href="#问题-xA-1" class="headerlink" title="问题&#xA;"></a>问题&#xA;</h4><p>挂载目录无读写权限。</p><h4 id="解决-xA-1"><a href="#解决-xA-1" class="headerlink" title="解决&#xA;"></a>解决&#xA;</h4><p>递归设置目录权限：</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 ./volumes</span><br></pre></td></tr></table></figure></div><h3 id="服务启动异常-xA"><a href="#服务启动异常-xA" class="headerlink" title="服务启动异常&#xA;"></a>服务启动异常&#xA;</h3><h4 id="解决-xA-2"><a href="#解决-xA-2" class="headerlink" title="解决&#xA;"></a>解决&#xA;</h4><p>通过日志排查问题：&#x20;</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f  # 查看所有服务日志</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker-compose logs dify-api  # 查看指定服务日志</span><br></pre></td></tr></table></figure></div><p>五、核心操作总结</p><h3 id="镜像替换流程-xA"><a href="#镜像替换流程-xA" class="headerlink" title="镜像替换流程&#xA;"></a>镜像替换流程&#xA;</h3><p>全局前缀替换 → 特殊镜像路径修正 → 基础镜像补充替换</p><h3 id="启动验证流程-xA"><a href="#启动验证流程-xA" class="headerlink" title="启动验证流程&#xA;"></a>启动验证流程&#xA;</h3><p>docker-compose up -d → docker-compose ps → 访问 Web 界面</p><h3 id="关键命令-xA"><a href="#关键命令-xA" class="headerlink" title="关键命令&#xA;"></a>关键命令&#xA;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/image: /image: docker.1ms.run\\//g&#x27; docker-compose.yaml</span><br><span class="line"></span><br><span class="line">chmod -R 777 ./volumes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></div>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Dify 部署流程：镜像源替换与服务启动&lt;/p&gt;
&lt;p&gt;一、Dify 镜像源替换操作&lt;/p&gt;
&lt;h3 id=&quot;批量替换镜像前缀-xA&quot;&gt;&lt;a href=&quot;#批量替换镜像前缀-xA&quot; class=&quot;headerlink&quot; title=&quot;批量替换镜像前缀&amp;#xA;&quot;&gt;&lt;/a&gt;批</summary>
      
    
    
    
    <category term="Dify" scheme="http://example.com/categories/Dify/"/>
    
    
    <category term="Dify" scheme="http://example.com/tags/Dify/"/>
    
    <category term="镜像源" scheme="http://example.com/tags/%E9%95%9C%E5%83%8F%E6%BA%90/"/>
    
  </entry>
  
</feed>
